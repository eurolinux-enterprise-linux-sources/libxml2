From 53a051852ec485ed1e41b07981b5f1ade7afcc6d Mon Sep 17 00:00:00 2001
From: Daniel Veillard <veillard@redhat.com>
Date: Thu, 25 Oct 2012 15:33:59 +0800
Subject: [PATCH] Fix a regression in 2.9.0 breaking validation while
 streaming
To: libvir-list@redhat.com

https://bugzilla.gnome.org/show_bug.cgi?id=684774
with help from Kjell Ahlstedt <kjell.ahlstedt@bredband.net>

Signed-off-by: Daniel Veillard <veillard@redhat.com>
---
 SAX2.c   | 2 +-
 parser.c | 7 +++++--
 2 files changed, 6 insertions(+), 3 deletions(-)

diff --git a/SAX2.c b/SAX2.c
index 1ed148f..802080a 100644
--- a/SAX2.c
+++ b/SAX2.c
@@ -2167,7 +2167,7 @@ xmlSAX2StartElementNs(void *ctx,
 	  (ctxt->myDoc->intSubset->elements == NULL) &&
 	  (ctxt->myDoc->intSubset->attributes == NULL) && 
 	  (ctxt->myDoc->intSubset->entities == NULL)))) {
-	xmlErrValid(ctxt, XML_ERR_NO_DTD,
+	xmlErrValid(ctxt, XML_DTD_NO_DTD,
 	  "Validation failed: no DTD found !", NULL, NULL);
 	ctxt->validate = 0;
     }
diff --git a/parser.c b/parser.c
index d7da608..69ad1df 100644
--- a/parser.c
+++ b/parser.c
@@ -11473,7 +11473,7 @@ xmlParseTryOrFinish(xmlParserCtxtPtr ctxt, int terminate) {
 			    "PP: Parsing internal subset\n");
 #endif
 		    ctxt->inSubset = 1;
-                    ctxt->progressive = 1;
+                    ctxt->progressive = 0;
 		    ctxt->checkIndex = 0;
 		    xmlParseDocTypeDecl(ctxt);
 		    if (RAW == '[') {
@@ -12055,7 +12055,10 @@ xmldecl_done:
 	}
 	ctxt->instate = XML_PARSER_EOF;
     }
-    return((xmlParserErrors) ctxt->errNo);	      
+    if (ctxt->wellFormed == 0)
+	return((xmlParserErrors) ctxt->errNo);
+    else
+        return(0);
 }
 
 /************************************************************************
-- 
1.7.11.7

